name: Auto Update Project Catalog

on:
  push:
    branches:
      - main
      - master
    paths:
      - '**/*.html'
      - '**/*.css'
      - '**/*.js'
      - '!catalog.js'
      - '!catalog.css'
      - '!index.html'
  workflow_dispatch:

jobs:
  update-catalog:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Scan and update catalog
        run: |
          python3 << 'EOF'
          import os
          import json
          import re
          from pathlib import Path
          
          def scan_projects():
              """æ‰«æé¡¹ç›®ç›®å½•ï¼Œè‡ªåŠ¨å‘çŽ°é¡¹ç›®"""
              projects = []
              base_path = Path('.')
              
              # æŽ’é™¤çš„ç›®å½•
              exclude_dirs = {'.git', '.github', 'node_modules', '__pycache__'}
              
              # æŸ¥æ‰¾æ‰€æœ‰åŒ…å« index.html æˆ–å…¶ä»– HTML æ–‡ä»¶çš„ç›®å½•
              project_dirs = set()
              
              for html_file in base_path.rglob('*.html'):
                  # è·³è¿‡æ ¹ç›®å½•çš„ index.html (è¿™æ˜¯ç›®å½•é¡µé¢)
                  if html_file.name == 'index.html' and html_file.parent == base_path:
                      continue
                  
                  # èŽ·å–é¡¹ç›®ç›®å½•
                  project_dir = html_file.parent
                  
                  # æ£€æŸ¥æ˜¯å¦åœ¨æŽ’é™¤åˆ—è¡¨ä¸­
                  if any(ex in project_dir.parts for ex in exclude_dirs):
                      continue
                  
                  project_dirs.add(project_dir)
              
              # ä¸ºæ¯ä¸ªé¡¹ç›®ç›®å½•ç”Ÿæˆé…ç½®
              for project_dir in sorted(project_dirs):
                  rel_path = project_dir.relative_to(base_path)
                  
                  # æŸ¥æ‰¾é¡¹ç›®æ–‡ä»¶
                  files = []
                  for file in project_dir.rglob('*'):
                      if file.is_file():
                          file_rel = file.relative_to(project_dir)
                          files.append(str(file_rel))
                  
                  # æŸ¥æ‰¾å…¥å£æ–‡ä»¶
                  entry_file = None
                  for name in ['index.html', '1.html', 'main.html']:
                      candidate = project_dir / name
                      if candidate.exists():
                          entry_file = str(rel_path / name)
                          break
                  
                  if not entry_file and files:
                      # ä½¿ç”¨ç¬¬ä¸€ä¸ª HTML æ–‡ä»¶
                      html_files = [f for f in files if f.endswith('.html')]
                      if html_files:
                          entry_file = str(rel_path / html_files[0])
                  
                  if not entry_file:
                      continue
                  
                  # ç”Ÿæˆé¡¹ç›®é…ç½®
                  project_id = str(rel_path).replace('\\', '/').replace('/', '-').replace('(', '').replace(')', '')
                  
                  # å°è¯•ä»Ž HTML ä¸­æå–æ ‡é¢˜
                  project_name = str(rel_path)
                  try:
                      with open(project_dir / (entry_file.split('/')[-1]), 'r', encoding='utf-8') as f:
                          content = f.read()
                          title_match = re.search(r'<title>([^<]+)</title>', content, re.IGNORECASE)
                          if title_match:
                              project_name = title_match.group(1).strip()
                  except:
                      pass
                  
                  # å›¾æ ‡æ˜ å°„
                  icon_map = {
                      'shop': 'ðŸ›’',
                      'cart': 'ðŸ›ï¸',
                      'grid': 'ðŸ“',
                      'layout': 'ðŸ“',
                      'css': 'ðŸŽ¨',
                      'style': 'ðŸŽ¨',
                  }
                  
                  icon = 'ðŸ“¦'
                  for keyword, emoji in icon_map.items():
                      if keyword in project_id.lower() or keyword in project_name.lower():
                          icon = emoji
                          break
                  
                  projects.append({
                      'id': project_id,
                      'name': project_name,
                      'description': f'é¡¹ç›®ç›®å½•: {rel_path}',
                      'icon': icon,
                      'path': entry_file.replace('\\', '/'),
                      'files': files[:10]  # é™åˆ¶æ–‡ä»¶åˆ—è¡¨é•¿åº¦
                  })
              
              return projects
          
          def update_catalog_js(projects):
              """æ›´æ–° catalog.js æ–‡ä»¶"""
              catalog_file = Path('catalog.js')
              
              if not catalog_file.exists():
                  print("catalog.js not found")
                  return False
              
              with open(catalog_file, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # ç”Ÿæˆæ–°çš„é¡¹ç›®é…ç½®
              projects_json = json.dumps(projects, ensure_ascii=False, indent=4)
              
              # æ›¿æ¢é¡¹ç›®é…ç½®éƒ¨åˆ†
              pattern = r'const projects = \[[\s\S]*?\];'
              new_config = f'const projects = {projects_json};'
              
              new_content = re.sub(pattern, new_config, content)
              
              if new_content != content:
                  with open(catalog_file, 'w', encoding='utf-8') as f:
                      f.write(new_content)
                  print(f"Updated catalog.js with {len(projects)} projects")
                  return True
              else:
                  print("No changes needed")
                  return False
          
          # ä¸»ç¨‹åº
          print("Scanning project directories...")
          projects = scan_projects()
          
          print(f"Found {len(projects)} projects:")
          for p in projects:
              print(f"  - {p['name']} ({p['id']})")
          
          if projects:
              changed = update_catalog_js(projects)
              if changed:
                  print("\nCatalog updated successfully!")
              else:
                  print("\nNo changes needed.")
          else:
              print("No projects found!")
          EOF
      
      - name: Check for changes
        id: check_changes
        run: |
          git diff --exit-code catalog.js || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add catalog.js
          git commit -m "ðŸ¤– Auto-update project catalog"
          git push
